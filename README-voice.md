# 语音功能使用说明

## 功能概述
机器人现在支持**中文语音输入**，可以通过语音发送任务、查询进度等所有命令。

## 配置要求

### 1. 获取OpenAI API密钥
1. 访问 [OpenAI平台](https://platform.openai.com/api-keys)
2. 创建新的API密钥
3. 在`.env`文件中添加：
```bash
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxx
```

### 2. 启用语音回复（可选）
如果希望机器人用语音回复，在`.env`中设置：
```bash
ENABLE_VOICE_REPLY=true
```

## 使用方法

### 语音输入
1. **在Telegram中录音**
   - 按住麦克风图标录音
   - 说出你的命令（中文）
   - 松开发送语音

2. **机器人处理流程**
   ```
   用户发送语音 → 机器人识别 → 显示识别结果 → 执行命令
   ```

3. **支持的语音命令**
   - ✅ 创建任务："为办公室采购十台新电脑"
   - ✅ 定时任务："每周五提交周报"
   - ✅ 查询任务："有什么任务"
   - ✅ 完成任务："周报完成了"
   - ✅ 查看进度："查看项目进度"

### 语音输出（需配置）
当`ENABLE_VOICE_REPLY=true`时：
- 机器人会同时发送文字和语音回复
- 使用OpenAI TTS生成自然中文语音

## 实际示例

### 示例1：语音创建任务
```
🎤 用户语音："为市场部采购五台笔记本电脑，下周完成"
📝 机器人：语音识别结果："为市场部采购五台笔记本电脑，下周完成"
✅ 机器人：任务预览...（等待确认）
```

### 示例2：语音查询
```
🎤 用户语音："有什么任务没完成"
📝 机器人：语音识别结果："有什么任务没完成"
📋 机器人：列出所有待办任务...
```

## 技术细节

### 使用的技术
- **语音识别**：OpenAI Whisper（支持中文）
- **语音合成**：OpenAI TTS（自然语音）
- **音频处理**：FFmpeg（格式转换）

### 支持的格式
- ✅ Telegram语音消息（.oga格式）
- ✅ 自动转换为MP3处理
- ❌ 不支持直接发送音频文件

### 临时文件管理
- 语音文件保存在`temp/`目录
- 每小时自动清理过期文件
- 处理完成立即删除

## 费用说明

使用OpenAI API会产生费用：
- **Whisper语音识别**：$0.006/分钟
- **TTS语音合成**：$0.015/1000字符

一般使用量很少，月费用通常在$1-5美元。

## 故障排除

### 问题1：语音无法识别
- 检查OpenAI API密钥是否正确
- 确认网络可以访问OpenAI API
- 查看日志：`tail -f /tmp/bot-voice.log`

### 问题2：没有语音回复
- 确认设置`ENABLE_VOICE_REPLY=true`
- 检查OpenAI余额是否充足

### 问题3：识别不准确
- 说话清晰，避免背景噪音
- 使用标准普通话
- 语音不要太长（建议30秒内）

## 无API密钥时的表现

如果未配置OpenAI API：
- 语音消息会提示"需要配置OpenAI API来识别"
- 建议用户使用文字消息
- 其他功能正常工作

## 安全提醒

⚠️ **重要**：
- 不要在代码中硬编码API密钥
- 使用`.env`文件管理密钥
- 不要将`.env`文件提交到Git